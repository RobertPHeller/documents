                                         1 Introduction (Informative)

   This specification describes the protocol for transporting OpenLCB events across the OpenLCB network.

                                         2 Intended Use (Informative)

   Transporting events provides general and flexible messaging between nodes, following the principles of
   the Producer-Consumer model.  The information is carried by an Event Identifier (Event ID ), a number
   which in of itself does not have any explicit information.  Instead the Event ID is assigned by the user
   to one specific concept, such as a specific lighting configuration, or a more abstract concept, such as
   the “start of the day” or “global stop”.   That concept can then be implemented by cooperative action
   between nodes that “produce” the event by sending messages, and nodes that “consume” the event by
   receiving messages and acting up them.  This document defines that interaction between produces and
   consumers in terms of OpenLCB messages.

                                     3 References and Context (Normative)

   This specification is in the context of the following OpenLCB-CAN Specifications:

     * The OpenLCB Message Network Standard, which defines the basic messages and how they interact.
       Higher-level protocols are based on this message network, but are defined elsewhere. The Message
       Network Standard defines the Initialized node state which is referenced here.

     * The OpenLCB Event Identifiers Standard, which defines the format and content of  Event IDs including
       the class of Well-Known Event IDs and Automatically-Routed Event IDs.

                                        4 Message Formats (Normative)

   In the following, “EventID Range” in the Data Content field refers to a range of EventID values
   specified through a compare-under-mask operation.  The low bit of the field defines the sign of the
   mask: a 1 least-significant bit indicates the mask is represented by 1 bits, and similarly for a 0 LSB.
   The mask is made up of the adjacent identical bits: if the lowest bit is a '0', then all low order
   contiguous '0' bits will form a mask, while if the lowest bit is a '1', then the low order contiguous
   '1' bits will form the mask.  The remaining upper bits determine the range prefix. To determine whether
   an Event ID “E” lies within the range “R”, compute:

   inRange = ( (E & ~ mask) == (R & ~ mask) )

    

4.1 Producer/Consumer Event Report (PCER)

                                                               Common              
   Name                           Dest ID Event ID Simple Node        Data Content
                                                               MTI    
   Producer/Consumer Event Report N       Y        N           0x05B4 EventID      

    

4.2 Identify Consumer

                                                  Common              
   Name              Dest ID Event ID Simple Node        Data Content
                                                  MTI    
   Identify Consumer N       Y        Y           0x08F4 Event ID     

4.3 Consumer Identified

                                                    Common                         
   Name                Dest ID Event ID Simple Node                   Data Content
                                                    MTI               
                                                    0x04C4 – Valid                 
   Consumer Identified N       Y        N           0x04C5 – Invalid  Event ID
                                                    0x04C6 – Reserved 
                                                    0x04C7 – Unknown  

    

   This message has three sub-forms, which carry the status of the identified consumer.  They are,
   respectively:

     * Currently valid – the internal state of the consumer & associated devices is known to be same as if
       it had just consumed this event

     * Currently invalid – the internal state of the consumer & associated devices is known to not be the
       same as if it had just consumed this event

     * Currently unknown – the consumer cannot determine whether either of the previous conditions is true

4.4 Consumer Range Identified

   Name                      Dest ID Event ID Simple Node CommonMTI Data Content  
   Consumer Range Identified N       Y        N           0x04A4    EventID Range 

    

   Nodes shall not emit Consumer Range Identified messages where more than 50% of the Event IDs included in
   the range are not consumed by the node.

4.5 Identify Producer

   Name              Dest ID Event ID Simple Node Common MTI Data Content 
   Identify Producer N       Y        Y           0x0914     Event ID     

    

4.6 Producer Identified

   Name                Dest ID Event ID Simple Node Common MTI        Data Content 
                                                    0x0544 – Valid                 
   Producer Identified N       Y        N           0x0545 – Invalid  Event ID
                                                    0x0546 – Reserved 
                                                    0x0547-- Unknown  

    

   This message has three sub-forms, which carry the status of the identified producer.  They are,
   respectively:

     * Currently valid – the internal state of the producer & associated devices is known to that which
       would cause them to produce the event

     * Currently invalid – the internal state of the producer & associated devices is known to not be the
       same as that which would cause them to produce the event

     * Currently unknown – the producer cannot determine whether either of the previous conditions is true

4.7 Producer Range Identified

                                                          Common               
   Name                      Dest ID Event ID Simple Node        Data Content
                                                          MTI    
   Producer Identified Range N       Y        N           0x0524 EventID Range 

    

   Nodes shall not emit Producer Range Identified messages where more than 50% of the Event IDs included in
   the range are not produced by the node.

4.8 Identify Events

                                                Common              
   Name            Dest ID Event ID Simple Node        Data Content
                                                MTI    
   Identify Events N       N        Y           0x0970              
                   Y       N        N           0x0968              

    

                                             5 States (Normative)

   Each consumer and producer of each event has two possible states:  “Unadvertised” and “Advertised”.

   When the node hosting the producer or consumer is not in Initialized state, the consumer or producer
   shall be in and remain in Unadvertised state.

   A producer or consumer of a specific event moves to Advertised state when any of the following happens:

     * The producer or consumer sends a Producer Identified or Consumer Identified, respectively, message
       containing the Event ID.

     * The producer or consumer sends a Producer Range Identified or Consumer Range Identified,
       respectively, message where the indicated range contains the Event ID.

     * Producers and consumers of Event IDs in the automatically-advertised range are in the Advertised
       state once the node is in the Initialized state.

   The messages defined by this Standard shall only be sent when the sending node is in Initialized state.

   Producer/Consumer Event Report messages may only be sent when the associated producer is in Advertised
   state.  OpenLCB equipment may, but is not required to, omit forwarding PCER messages to a consumer of a
   particular Event ID when that consumer is in Unadvertised state.

                                          6 Interactions (Normative)

   After each transition to Initialized State and before sending a Producer/Consumer Event Report (PCER)
   message producing a specific Event ID outside the automatically-routed Event ID range, a node shall emit
   a Producer Identified or Producer Range Identified message identifying that Event ID.

   To ensure receipt of PCER messages, a node consuming a specific Event ID outside the
   automatically-routed Event ID shall emit a Consumer Identified or Consumer Range Identified message
   identifying that Event ID.

6.1 Event Transfer

   To produce an event, the node containing the producer emits a PCER message containing the related Event
   ID. The OpenLCB message network transports that message to all attached nodes, except as described in
   the next paragraph. Nodes containing consumers shall check for a match between the message Event ID and
   their consumers. If a match is found, the consumer shall perform any local operations configured into
   it. If a match is not found, the consumer shall not perform any local operations.

   Equipment that transports PCER messages shall transport them to all connected nodes from which the
   equipment has received a Consumer Identified or Consumer Range Identified for the reported Event ID.
   Equipment that transports PCER messages shall transport all PCER messages containing Event IDs in the
   automatically-routed range to all connected nodes. Equipment that transports PCER messages may, but is
   not required to, omit transporting PCER messages with Event ID outside the automatically-routed range to
   nodes from which the equipment has not received a Consumer Identified or Consumer Range Identified for
   the reported Event ID.

6.2 Event Enquiry

   Upon receipt of either an unaddressed (global) Identify Events message or an addressed Identify Events
   message addressed to the node, that node shall reply with Producer Identified and/or Producer Range
   Identified messages covering all non-automatically-routed Event IDs produced by the node, and Consumer
   Identified and/or Consumer Range Identified messages covering all non-automatically-routed Event IDs
   consumed by the node.

   In response to an unaddressed (global) Identify Events message or an addressed Identify Events message
   address to the node, that node may but is not required to include Producer Identified and/or Producer
   Range Identified messages covering automatically-routed Event IDs produced by the node, and Consumer
   Identified and/or Consumer Range Identified messages covering automatically-routed Event IDs consumed by
   the node.

6.3 Producer Enquiry

   Upon receipt of an Identify Producer message, a node shall reply with Producer Identified and/or
   Producer Range Identified messages covering all non-automatically-routed Event IDs produced by the node.

   In response to an Identify Producer message, a node may but is not required to include Producer
   Identified and/or Producer Range Identified messages covering automatically-routed Event IDs produced by
   the node.

6.4 Consumer Enquiry

   Upon receipt of an Identify Consumer message, a node shall reply with Consumer Identified and/or
   Consumer Range Identified messages covering all non-automatically-routed Event IDs consumed by the node.

   In response to an Identify Consumer message, a node may but is not required to include Consumer
   Identified and/or Consumer Range Identified messages covering automatically-routed Event IDs consumed by
   the node.

                                        7 Adaptation to CAN Transport

   Due to the limitations of CAN, namely a 29-bit header and 8-byte data-part, the format of CAN Event
    messages have been adapted, as per the following table.  

    

   Message                                                                                                  
                                    Dest ID   Event ID Simple Node Header Format          Data-part Content
   Name                             
   Producer/Consumer Event Report   N         Y        N           0x195B,4sss  1         EventID           
   (PCER)                           
   Identify Consumer                N         Y        Y           0x198F,4sss            Event ID          
                                                                   0x194C,4sss - Valid2                     
                                                                                          
                                                                                          
                                                                   0x194C,5sss - Invalid  
   Consumer Identified              N         Y        N                                  Event ID
                                                                                          
                                                                   0x194C,6sss - Reserved 
                                                                                          
                                                                   0x194C,7sss - Unknown  
   Consumer Range Identified        N         Y        N           0x194A,4sss            EventID Range     
   Identify Producer                N         Y        Y           0x1991,4sss            Event ID          
                                                                   0x1954,4sss - Valid                      
                                                                                          
                                                                   0x1954,5sss - Invalid  
   Producer Identified              N         Y        N                                  Event ID
                                                                   0x1954,6sss - Reserved 
                                                                                          
                                                                   0x1954,7sss - Unknown  
   Producer Identified Range        N         Y        N           0x1952,4sss            EventID Range     
   Identify Events                  N         N        Y           0x1997,0sss                              
                                    Y         N        N           0x1996,8sss            0ddd3             
   Footnotes:                       
   1  sss - The 12-bit source alias field.
   2  Quality - Producer and Consumer Identified messages are flagged with the validity of the reply.
   3 0ddd - First two bytes of the data-part, representing the 12-bit destination Alias, the top 4 bits are
   zero.                            

    

    

   Table of Contents

   1 Introduction (Informative)

   2 Intended Use (Informative)

   3 References and Context (Normative)

   4 Message Formats (Normative)

   4.1 Producer/Consumer Event Report (PCER)

   4.2 Identify Consumer

   4.3 Consumer Identified

   4.4 Consumer Range Identified

   4.5 Identify Producer

   4.6 Producer Identified

   4.7 Producer Range Identified

   4.8 Identify Events

   5 States (Normative)

   6 Interactions (Normative)

   6.1 Event Transfer

   6.2 Event Enquiry

   6.3 Producer Enquiry

   6.4 Consumer Enquiry

   7 Adaptation to CAN Transport

    
